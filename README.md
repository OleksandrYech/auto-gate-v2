# Система автоматизації воріт для ЖК

Оптимізована система автоматизації воріт з розпізнаванням номерних знаків для Raspberry Pi 5.

## Особливості

- **Детекція автомобілів** за допомогою MobileNet SSD
- **Розпізнавання номерних знаків** з використанням спеціалізованих моделей
- **Інтеграція з Google Sheets** для управління доступом
- **Подвійна камера** для контролю в'їзду та виїзду
- **Захист від непередбачуваних ситуацій** з моніторингом безпеки
- **Автоматичне управління воротами** з детекцією проїзду
- **Фільтрація дублікатів** для уникнення повторних записів

## Апаратні вимоги

- Raspberry Pi 5 з Raspberry OS 64-bit Debian 12
- 2x реле для керування пультом Genius JA592
- Ультразвуковий датчик JSN-SR04T
- Герконовий датчик MC-38
- Camera Module 3 (для в'їзду)
- Camera Module 2 (для виїзду)

## GPIO конфігурація

- **GPIO 17** - Реле відкриття (OPEN)
- **GPIO 27** - Реле закриття (CLOSE)
- **GPIO 22** - Герконовий датчик
- **GPIO 23** - JSN-SR04T Trigger
- **GPIO 24** - JSN-SR04T Echo

## Встановлення

### 1. Клонування репозиторію
```bash
git clone https://github.com/YourUsername/gate-automation.git
cd gate-automation
```

### 2. Запуск скрипта встановлення
```bash
chmod +x install.sh
./install.sh
```

### 3. Налаштування Google Sheets API

1. Створіть проект в [Google Cloud Console](https://console.cloud.google.com)
2. Увімкніть Google Sheets API
3. Створіть Service Account та завантажте credentials.json
4. Скопіюйте credentials.json в кореневу директорію проекту
5. Надайте доступ Service Account до вашої Google таблиці

### 4. Завантаження моделей

Розмістіть наступні файли в директорії `models/`:
- `license.onnx` - модель детекції номерних знаків
- `ocr.pt` - модель розпізнавання символів

### 5. Створення зон інтересу (ROI)

```bash
./create_roi.sh
```

Слідуйте інструкціям на екрані для визначення зон детекції.

## Використання

### Запуск системи
```bash
./start.sh
```

### Запуск як системний сервіс
```bash
sudo systemctl start gate_automation
sudo systemctl enable gate_automation  # для автозапуску
```

### Перегляд логів
```bash
sudo journalctl -u gate_automation -f
```

### Тестування обладнання
```bash
source venv/bin/activate
python main.py --test-hardware
```

## Структура Google Sheets

Таблиця повинна мати наступні колонки:
- **A** - Дозволені номерні знаки (починаючи з рядка 3)
- **B** - Час останнього розпізнавання
- **D** - Заборонені номери (спроби несанкціонованого доступу)
- **E** - Час спроби заборонених номерів
- **G** - Номери на виїзд
- **H** - Час виїзду

## Налаштування

Основні параметри можна змінити в файлі `config.py`:

### Пороги впевненості
```python
MODEL_CONFIG = {
    "VEHICLE_DETECTION": {
        "confidence_threshold": 0.7,  # Для детекції авто
    },
    "LICENSE_PLATE_DETECTION": {
        "confidence_threshold": 0.6,  # Для детекції номерів
    },
    "OCR": {
        "confidence_threshold": 0.4,  # Для розпізнавання символів
    }
}
```

### Таймінги
```python
TIMING_CONFIG = {
    "gate_close_delay": 5,       # Затримка закриття після проїзду
    "duplicate_timeout": 60,     # Ігнорування дублікатів (сек)
    "sensor_timeout": 30,        # Таймаут датчиків
}
```

## Принцип роботи

### В'їзд
1. Детекція автомобіля в зоні інтересу
2. Розпізнавання номерного знаку
3. Перевірка доступу в Google Sheets
4. Відкриття воріт при наявності доступу
5. Детекція проїзду через ворота
6. Автоматичне закриття воріт

### Виїзд
1. Детекція автомобіля
2. Спроба розпізнавання номера (необов'язково)
3. Запис інформації про виїзд
4. Відкриття воріт в будь-якому випадку
5. Автоматичне закриття після проїзду

## Безпека

- Автоматична зупинка при відсутності відповіді від датчиків
- Захист від закриття воріт при наявності автомобіля в зоні
- Аварійна зупинка системи при критичних помилках
- Логування всіх подій для аудиту

## Усунення неполадок

### Камери не працюють
```bash
# Перевірка камер
libcamera-hello --list-cameras
# Перезавантаження драйверів
sudo systemctl restart camera
```

### GPIO помилки
```bash
# Перевірка прав доступу
groups $USER  # повинна містити gpio
# Додавання до групи
sudo usermod -a -G gpio $USER
```

### Проблеми з Google Sheets
- Перевірте наявність credentials.json
- Переконайтеся, що Service Account має доступ до таблиці
- Перевірте правильність ID таблиці в config.py

## Ліцензія

MIT License